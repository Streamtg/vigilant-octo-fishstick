name: Visita humana al blog con Puppeteer

on:
  workflow_dispatch:

jobs:
  visit-blog:
    runs-on: ubuntu-latest
    timeout-minutes: 20  # Evita cancelación automática

    strategy:
      fail-fast: false
      matrix:
        instance: [1, 2, 3, 4, 5]  # ← Puedes aumentar a 20 cuando confirmes estabilidad

    steps:
      - name: 📁 Clonar el repositorio
        uses: actions/checkout@v3

      - name: 🧰 Configurar Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: 📦 Instalar Puppeteer
        run: npm install puppeteer

      - name: 📦 Instalar puppeteer-extra y plugin stealth
        run: npm install puppeteer-extra puppeteer-extra-plugin-stealth

      - name: 📝 Crear script de navegación
        run: |
          cat << 'EOF' > visitBlog.js
          const puppeteer = require('puppeteer-extra');
          const StealthPlugin = require('puppeteer-extra-plugin-stealth');
          puppeteer.use(StealthPlugin());

          const userAgents = [
            'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.0.0 Safari/537.36',
            'Mozilla/5.0 (Macintosh; Intel Mac OS X 13_2) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.0 Safari/605.1.15',
            'Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:123.0) Gecko/20100101 Firefox/123.0',
            'Mozilla/5.0 (Linux; Android 13; Pixel 6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.6167.101 Mobile Safari/537.36',
            'Mozilla/5.0 (iPhone; CPU iPhone OS 17_3 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) CriOS/121.0.6167.140 Mobile/15E148 Safari/604.1'
          ];

          const referers = [
            'https://www.google.com/',
            'https://www.facebook.com/',
            'https://twitter.com/',
            'https://www.reddit.com/',
            'https://www.bing.com/',
            'https://duckduckgo.com/'
          ];

          const getRandom = arr => arr[Math.floor(Math.random() * arr.length)];

          (async () => {
            const browser = await puppeteer.launch({
              headless: false,
              args: ['--no-sandbox', '--disable-setuid-sandbox']
            });

            const page = await browser.newPage();

            const userAgent = getRandom(userAgents);
            const referer = getRandom(referers);
            const width = 800 + Math.floor(Math.random() * 400);
            const height = 600 + Math.floor(Math.random() * 300);

            await page.setUserAgent(userAgent);
            await page.setExtraHTTPHeaders({ referer });
            await page.setViewport({ width, height });

            console.log('🧠 Navegando como:', userAgent);
            console.log('🔗 Referer:', referer);

            try {
              await page.goto('https://yoelmod.blogspot.com', { waitUntil: 'domcontentloaded', timeout: 60000 });

              // Simular scroll humano
              for (let i = 0; i < 4; i++) {
                await page.mouse.wheel({ deltaY: 300 + Math.random() * 200 });
                await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 2000));
              }

              await page.mouse.move(
                100 + Math.random() * 400,
                100 + Math.random() * 300
              );

              const waitTime = 20000 + Math.random() * 20000;
              console.log(`⏱️ Esperando ${(waitTime / 1000).toFixed(1)} segundos...`);
              await new Promise(resolve => setTimeout(resolve, waitTime));

              console.log('✅ Visita completada.');
            } catch (err) {
              console.error('❌ Error durante la navegación:', err.message);
            } finally {
              await browser.close();
            }
          })();
          EOF

      - name: 🚀 Ejecutar visita al blog
        run: node visitBlog.js
