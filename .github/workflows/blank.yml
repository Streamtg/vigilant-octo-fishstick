name: Telegram WebStreamer Bot with Ngrok

on:
  schedule:
    - cron: '0 */6 * * *'  # Ejecutar cada 6 horas
  workflow_dispatch:

jobs:
  bot:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    env:
      API_ID: ${{ secrets.API_ID }}
      API_HASH: ${{ secrets.API_HASH }}
      BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
      BIN_CHANNEL: ${{ secrets.BIN_CHANNEL }}
      PORT: 8080

    steps:
    - name: Checkout del repositorio
      uses: actions/checkout@v3

    - name: Instalar dependencias bÃ¡sicas
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-venv curl jq ntpdate

    - name: Sincronizar reloj del sistema (evita error BadMsgNotification)
      run: |
        sudo ntpdate time.google.com
        timedatectl
        date

    - name: Clonar TG-FileStreamBot (rama webui)
      run: |
        git clone --branch webui https://github.com/EverythingSuckz/TG-FileStreamBot.git
        cd TG-FileStreamBot
        python3 -m venv venv
        source venv/bin/activate
        pip install --upgrade pip
        pip install -r requirements.txt

    - name: Instalar Ngrok
      run: |
        curl -sSL https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
        echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
        sudo apt update
        sudo apt install -y ngrok
        ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}

    - name: Iniciar Ngrok (modo background)
      run: |
        nohup ngrok http $PORT > ngrok.log &
        sleep 8
        echo "ðŸ”— URL pÃºblica de Ngrok:"
        curl -s http://127.0.0.1:4040/api/tunnels | jq -r '.tunnels[0].public_url'

    - name: Iniciar el bot WebStreamer
      run: |
        cd TG-FileStreamBot
        source venv/bin/activate
        python3 -m WebStreamer
