name: Visita humana al blog (Windows)

on:
  workflow_dispatch:

jobs:
  visit-blog:
    runs-on: windows-latest
    timeout-minutes: 20

    strategy:
      fail-fast: false
      matrix:
        instance: [1, 2, 3, 4, 5]  # Aumenta cuando confirmes estabilidad

    steps:
      - name: 📁 Checkout del repositorio
        uses: actions/checkout@v3

      - name: 🧰 Configurar Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: 📦 Instalar Puppeteer + Stealth
        run: npm install puppeteer puppeteer-extra puppeteer-extra-plugin-stealth

      - name: 📝 Crear script de navegación
        run: |
          echo const puppeteer = require('puppeteer-extra'); > visitBlog.js
          echo const StealthPlugin = require('puppeteer-extra-plugin-stealth'); >> visitBlog.js
          echo puppeteer.use(StealthPlugin()); >> visitBlog.js
          echo const userAgents = [ >> visitBlog.js
          echo   'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.0.0 Safari/537.36', >> visitBlog.js
          echo   'Mozilla/5.0 (Macintosh; Intel Mac OS X 13_2) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.0 Safari/605.1.15', >> visitBlog.js
          echo   'Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:123.0) Gecko/20100101 Firefox/123.0', >> visitBlog.js
          echo   'Mozilla/5.0 (Linux; Android 13; Pixel 6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.6167.101 Mobile Safari/537.36', >> visitBlog.js
          echo   'Mozilla/5.0 (iPhone; CPU iPhone OS 17_3 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) CriOS/121.0.6167.140 Mobile/15E148 Safari/604.1' >> visitBlog.js
          echo ]; >> visitBlog.js
          echo const referers = [ >> visitBlog.js
          echo   'https://www.google.com/', >> visitBlog.js
          echo   'https://www.facebook.com/', >> visitBlog.js
          echo   'https://twitter.com/', >> visitBlog.js
          echo   'https://www.reddit.com/', >> visitBlog.js
          echo   'https://www.bing.com/', >> visitBlog.js
          echo   'https://duckduckgo.com/' >> visitBlog.js
          echo ]; >> visitBlog.js
          echo const getRandom = arr => arr[Math.floor(Math.random() * arr.length)]; >> visitBlog.js
          echo (async () => { >> visitBlog.js
          echo const browser = await puppeteer.launch({ headless: false, args: ['--no-sandbox', '--disable-setuid-sandbox'] }); >> visitBlog.js
          echo const page = await browser.newPage(); >> visitBlog.js
          echo const userAgent = getRandom(userAgents); >> visitBlog.js
          echo const referer = getRandom(referers); >> visitBlog.js
          echo const width = 800 + Math.floor(Math.random() * 400); >> visitBlog.js
          echo const height = 600 + Math.floor(Math.random() * 300); >> visitBlog.js
          echo await page.setUserAgent(userAgent); >> visitBlog.js
          echo await page.setExtraHTTPHeaders({ referer }); >> visitBlog.js
          echo await page.setViewport({ width, height }); >> visitBlog.js
          echo console.log('🧠 User-Agent:', userAgent); >> visitBlog.js
          echo console.log('🔗 Referer:', referer); >> visitBlog.js
          echo try { >> visitBlog.js
          echo await page.goto('https://yoelmod.blogspot.com', { waitUntil: 'domcontentloaded', timeout: 60000 }); >> visitBlog.js
          echo for (let i = 0; i < 4; i++) { >> visitBlog.js
          echo   await page.mouse.wheel({ deltaY: 300 + Math.random() * 200 }); >> visitBlog.js
          echo   await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 2000)); >> visitBlog.js
          echo } >> visitBlog.js
          echo await page.mouse.move(100 + Math.random() * 400, 100 + Math.random() * 300); >> visitBlog.js
          echo const waitTime = 20000 + Math.random() * 20000; >> visitBlog.js
          echo console.log(`⏱️ Esperando ${waitTime / 1000} segundos...`); >> visitBlog.js
          echo await new Promise(resolve => setTimeout(resolve, waitTime)); >> visitBlog.js
          echo console.log('✅ Visita completada.'); >> visitBlog.js
          echo } catch (err) { >> visitBlog.js
          echo console.error('❌ Error durante la navegación:', err.message); >> visitBlog.js
          echo } finally { >> visitBlog.js
          echo await browser.close(); >> visitBlog.js
          echo } >> visitBlog.js
          echo })(); >> visitBlog.js

      - name: 🚀 Ejecutar visita
        run: node visitBlog.js
