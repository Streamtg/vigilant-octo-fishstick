name: Run FileStreamBot with Venv (No Docker)

on:
  workflow_dispatch:  # Ejecutar manualmente desde GitHub

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Clonar repositorio FileStreamBot
        run: |
          git clone https://github.com/avipatilpro/FileStreamBot
          cd FileStreamBot

      - name: ⚙️ Crear entorno virtual y activar
        working-directory: ./FileStreamBot
        run: |
          python3 -m venv venv
          source venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: 📄 Crear archivo `.env` desde Secrets
        working-directory: ./FileStreamBot
        run: |
          cat > .env <<EOF
          API_ID=${{ secrets.API_ID }}
          API_HASH=${{ secrets.API_HASH }}
          BOT_TOKEN=${{ secrets.BOT_TOKEN }}
          ULOG_CHANNEL=${{ secrets.ULOG_CHANNEL }}
          FLOG_CHANNEL=${{ secrets.FLOG_CHANNEL }}
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          FQDN=${{ secrets.FQDN }}
          HAS_SSL=${{ secrets.HAS_SSL }}
          MULTI_TOKEN1=${{ secrets.MULTI_TOKEN1 }}
          MULTI_TOKEN2=${{ secrets.MULTI_TOKEN2 }}
          OWNER_ID=${{ secrets.OWNER_ID }}
          PORT=8080
          CHANNEL_ID=${{ secrets.CHANNEL_ID }}
          EOF

      - name: ▶️ Ejecutar FileStreamBot en segundo plano
        working-directory: ./FileStreamBot
        run: |
          source venv/bin/activate
          nohup python3 -m FileStream > bot.log 2>&1 &
          echo "Bot ejecutándose en segundo plano..."

      - name: 💤 Mantener el runner activo
        run: sleep 60
