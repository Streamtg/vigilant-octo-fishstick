name: Navegaci√≥n humana con Stealth Puppeteer (216 combinaciones)

on:
  schedule:
    - cron: '0 */12 * * *'
  workflow_dispatch:

jobs:
  puppeteer-cartesian:
    runs-on: ubuntu-22.04

    strategy:
      max-parallel: 20
      fail-fast: false
      matrix:
        go: [1.0, 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7, 1.8, 1.9, 2.1, 2.2]
        flag: [A, B, C, D, E, F, G, H, I, G, K, L, M, N, √ë, O, P, K]

    env:
      GO_VERSION: ${{ matrix.go }}
      FLAG: ${{ matrix.flag }}

    steps:
      - name: Mostrar combinaci√≥n actual
        run: echo "GO=${GO_VERSION}, FLAG=${FLAG}"

      - name: Instalar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Instalar dependencias de Chromium y Xvfb
        run: |
          sudo apt-get update
          sudo apt-get install -y libx11-dev libxss1 libappindicator3-1 \
            libatk-bridge2.0-0 libatk1.0-0 libcups2 libdbus-1-3 libgdk-pixbuf2.0-0 \
            libnspr4 libnss3 libxcomposite1 libxdamage1 libxrandr2 xdg-utils wget xvfb

      - name: Crear script con Stealth Puppeteer
        run: |
          mkdir puppeteer-script
          cat << 'EOF' > puppeteer-script/index.js
          const puppeteer = require('puppeteer-extra');
          const stealth = require('puppeteer-extra-plugin-stealth');
          puppeteer.use(stealth());

          const userAgents = [
            'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.0.0 Safari/537.36',
            'Mozilla/5.0 (Macintosh; Intel Mac OS X 13_2) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.0 Safari/605.1.15',
            'Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:123.0) Gecko/20100101 Firefox/123.0',
            'Mozilla/5.0 (Linux; Android 13; Pixel 6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.6167.101 Mobile Safari/537.36',
            'Mozilla/5.0 (iPhone; CPU iPhone OS 17_3 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) CriOS/121.0.6167.140 Mobile/15E148 Safari/604.1'
          ];

          const referers = [
            'https://www.google.com/',
            'https://www.facebook.com/',
            'https://twitter.com/',
            'https://www.reddit.com/',
            'https://www.bing.com/',
            'https://www.youtube.com/',
            'https://duckduckgo.com/'
          ];

          const getRandom = arr => arr[Math.floor(Math.random() * arr.length)];

          (async () => {
            const browser = await puppeteer.launch({
              headless: false,
              args: ['--no-sandbox', '--disable-setuid-sandbox']
            });

            const page = await browser.newPage();

            const userAgent = getRandom(userAgents);
            const referer = getRandom(referers);
            const width = 800 + Math.floor(Math.random() * 400);
            const height = 600 + Math.floor(Math.random() * 300);

            await page.setUserAgent(userAgent);
            await page.setExtraHTTPHeaders({ referer });
            await page.setViewport({ width, height });

            console.log(`üß† Navegando como: ${userAgent}`);
            console.log(`üîó Referer simulado: ${referer}`);

            await page.goto('https://yoelmod.blogspot.com', { waitUntil: 'networkidle2' });

            await new Promise(resolve => setTimeout(resolve, 2000 + Math.random() * 3000));

            await page.evaluate(async () => {
              for (let i = 0; i < 5; i++) {
                window.scrollBy(0, 300 + Math.random() * 200);
                await new Promise(resolve => setTimeout(resolve, 500 + Math.random() * 1000));
              }
            });

            await page.mouse.move(100 + Math.random() * 300, 100 + Math.random() * 300);

            await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 1000));

            console.log(`‚úÖ Visita simulada completa para GO=${process.env.GO_VERSION} FLAG=${process.env.FLAG}`);

            await browser.close();
          })();
          EOF

      - name: Instalar Puppeteer con Stealth
        run: |
          cd puppeteer-script
          npm init -y
          npm install puppeteer puppeteer-extra puppeteer-extra-plugin-stealth

      - name: Ejecutar navegaci√≥n con Xvfb y Stealth
        run: xvfb-run --auto-servernum --server-args='-screen 0 1280x720x24' node puppeteer-script/index.js
