name: Telegram FileStreamBot con Pyrogram 2.0+ y soporte Ngrok

on: workflow_dispatch:

jobs: run: runs-on: ubuntu-latest timeout-minutes: 360

env:
  API_ID: ${{ secrets.API_ID }}
  API_HASH: ${{ secrets.API_HASH }}
  BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
  BIN_CHANNEL: ${{ secrets.BIN_CHANNEL }}
  PORT: 8080
  FQDN: ${{ secrets.FQDN }}

steps:
  - name: Clonar el repositorio
    run: |
      git clone --branch v2.1 https://github.com/EverythingSuckz/TG-FileStreamBot.git

  - name: Preparar entorno virtual e instalar dependencias
    run: |
      cd TG-FileStreamBot
      python3 -m venv venv
      . venv/bin/activate
      pip install --upgrade pip
      pip install -r requirements.txt

  - name: Parchear compatibilidad Pyrogram 2.x
    run: |
      cd TG-FileStreamBot/WebStreamer

      # Parchear nombre del argumento de session a name si es necesario
      sed -i 's/session_name=/name=/' bot/__init__.py || true

      # Parchear el error log_msg.message_id -> log_msg.id
      sed -i 's/log_msg.message_id/log_msg.id/g' bot/plugins/stream.py || true

  - name: Instalar y configurar Ngrok
    run: |
      curl -sSL https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
      echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
      sudo apt-get update && sudo apt-get install -y ngrok
      ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}

  - name: Iniciar Ngrok
    run: |
      nohup ngrok http 8080 &

  - name: Iniciar el bot
    run: |
      cd TG-FileStreamBot
      . venv/bin/activate
      python3 -m WebStreamer

